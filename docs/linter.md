# XSigma Linter

## Overview
The `Tools/linter` package hosts XSigma's lint and formatting toolchain. It
collects thin adapter scripts that wrap external tools, along with shared
Python helpers that let every adapter participate in the repository's
`lintrunner` workflow. The suite keeps code style consistent, enforces project
policy (for example, GitHub workflow safeguards), and runs static analysis that
would otherwise require bespoke shell scripting.

## Folder Structure
| Path | Description |
| --- | --- |
| `Tools/linter/__init__.py` | Marks the package as importable so adapters can share helpers. |
| `Tools/linter/README.md` | High-level documentation (this file). |
| `Tools/linter/dictionary.txt` | Shared allow-list for `codespell`; keep it sorted and deduplicated. |
| `Tools/linter/adapters/` | Individual adapter entrypoints plus the shared `_linter` framework. |
| `Tools/linter/adapters/_linter/` | Tokeniser, parser, and CLI scaffolding for Python-focused adapters. |
| `Tools/linter/adapters/README.md` | Adapter authoring checklist (protocol, dry-run behaviour, etc.). |
| `Tools/linter/clang_tidy/` | Support code for the clang-tidy adapter (compile database generation). |
| `Tools/linter/clang_tidy/__init__.py` | Package marker for clang-tidy helpers. |

The adapter directory contains one script per lint code (for example
`clangformat_linter.py`, `mypy_linter.py`) plus project-specific data such as
`docstring_linter-grandfather.json` and `s3_init_config.json`.

## Functionality
- **Formatting and style**: `pyfmt`, `ruff`, `clangformat`, and `codespell` keep
  Python and C++ sources consistent and typo-free.
- **Static analysis**: `mypy_linter`, `pyrefly_linter`, `ruff_linter`, and
  `clangtidy_linter` provide type checking, linting, and C++ diagnostics.
- **Build and dependency hygiene**: `cmake_linter`, `cmake_minimum_required_linter`,
  `bazel_linter`, and `nativefunctions_linter` validate build scripts and
  generated metadata.
- **Workflow safety**: `actionlint_linter`, `gha_linter`, `workflow_consistency_linter`,
  and `no_workflows_on_fork` harden GitHub Actions configuration.
- **Repository policy**: `set_linter`, `docstring_linter`, `header_only_linter`,
  `testowners_linter`, `test_device_bias_linter`, and `test_has_main_linter`
  encode XSigma-specific conventions.
- **Infrastructure helpers**: `pip_init.py`, `s3_init.py`, `update_s3.py`, and
  `clang_tidy/generate_build_files.py` provision third-party binaries and prepare
  compilation databases.

All adapters emit the JSON protocol expected by `lintrunner`, so they can run
either individually or behind the aggregated developer workflow.

## Command-Line Usage

### Running through `lintrunner`
`lintrunner` orchestrates adapters, applies autofixes, and collects diagnostics.
Typical usage:

```bash
lintrunner [--take LINT_CODE] [-a | --apply] [--paths PATHSFILE] [--fix]
```

Common runner flags referenced throughout the adapters:
- `--take LINT_CODE` - limit execution to a single adapter (for example,
  `--take PYFMT`).
- `-a`, `--apply` - apply autofixes offered by an adapter.
- `--paths PATHSFILE` - run on file lists generated by `lintrunner dry-run`
  or other tooling.
- `--skip-deps`, `--no-check`, and other pass-through flags - see
  `lintrunner --help` for the complete runner CLI.

Adapters derived from `_linter.FileLinter` understand additional shared flags:
- `files` - positional arguments listing files or directories.
- `--fix` - apply edits in place (mutually exclusive with `--lintrunner`).
- `--lintrunner` - emit machine-readable `LintMessage` JSON to stdout.
- `--verbose` - print progress messages to stderr.

### Adapter CLI reference
Each adapter can also run directly. The table below lists the primary options
declared in each script; unless noted otherwise, adapters accept one or more
positional file paths at the end.

| Lint code | Script | Purpose | Key options |
| --- | --- | --- | --- |
| ACTIONLINT | `adapters/actionlint_linter.py` | Wraps `actionlint` for GitHub workflow validation. | `--binary PATH` (required); `filenames...` |
| BAZEL_LINTER | `adapters/bazel_linter.py` | Flags unstable `http_archive` checksums. | `--binary PATH` (required); `filenames...` |
| CLANGFORMAT | `adapters/clangformat_linter.py` | Runs `clang-format` and captures diffs. | `--binary PATH` (required); `--retries N`; `--timeout SEC`; `--verbose`; `filenames...` |
| CLANGTIDY | `adapters/clangtidy_linter.py` | Executes `clang-tidy` using a build directory. | `--binary PATH` (required); `--build-dir DIR` (required); `--verbose`; `filenames...` |
| CMAKE | `adapters/cmake_linter.py` | Applies `cmakelint` with repo defaults. | `--config PATH` (required); `filenames...` |
| CMAKE_MINIMUM_REQUIRED | `adapters/cmake_minimum_required_linter.py` | Ensures CMake and dependency minimum versions match project policy. | `--verbose`; `filenames...` |
| CODESPELL | `adapters/codespell_linter.py` | Runs `codespell` with the shared dictionary. | `--verbose`; `filenames...` |
| DOCSTRING | `adapters/docstring_linter.py` | Requires docstrings on large classes/functions. | Shared `FileLinter` flags; plus `--grandfather PATH`; `--grandfather-tolerance PERCENT`; `--lint-init`; `--lint-local`; `--lint-protected`; `--max-class N`; `--max-def N`; `--min-docstring N`; `--no-grandfather`; `--report`; `--write-grandfather`. |
| EXEC | `adapters/exec_linter.py` | Checks that source files are non-executable. | `--verbose`; `filenames...` |
| FLAKE8 | `adapters/flake8_linter.py` | Wraps `flake8` and plugin set. | `--flake8-plugins-path DIR`; `--severity CODE:LEVEL` (repeatable); `--retries N`; `--verbose`; `filenames...` |
| GB_REGISTRY | `adapters/gb_registry_linter.py` | Synchronises dynamo graph-break registry entries. | `--dynamo-dir PATH`; `--registry-path PATH` |
| GHA | `adapters/gha_linter.py` | Verifies `secrets: inherit` in workflow jobs. | `filenames...` |
| GREP | `adapters/grep_linter.py` | Generic pattern matcher with optional sed fixes. | `--pattern REGEX` (required); `--allowlist-pattern REGEX`; `--linter-name CODE`; `--match-first-only`; `--error-name TEXT`; `--error-description TEXT`; `--replace-pattern SED_EXPR`; `--verbose`; `filenames...` |
| HEADER_ONLY_LINTER | `adapters/header_only_linter.py` | Validates header-only API smoke tests. | (No additional options; uses repo defaults.) |
| IMPORT | `adapters/import_linter.py` | Blocks disallowed third-party imports. | `filepaths...` (positional only) |
| LINTRUNNER_VERSION | `adapters/lintrunner_version_linter.py` | Confirms the local `lintrunner` is up to date. | No CLI options; run the script directly. |
| MYPY | `adapters/mypy_linter.py` | Wraps `dmypy`/`mypy` type checking. | `--retries N`; `--config PATH` (required); `--code CODE`; `--verbose`; `filenames...` |
| NATIVEFUNCTIONS | `adapters/nativefunctions_linter.py` | Round-trips `native_functions.yaml` with `ruamel`. | `--native-functions-yml PATH` (required) |
| NEWLINE | `adapters/newlines_linter.py` | Enforces POSIX newlines and bans CRLF. | `--verbose`; `filenames...` |
| MERGE_CONFLICTLESS_CSV | `adapters/no_merge_conflict_csv_linter.py` | Pads CSV rows to avoid merge conflicts. | `--verbose`; `filenames...` |
| NO_WORKFLOWS_ON_FORK | `adapters/no_workflows_on_fork.py` | Adds fork guards to workflow jobs. | `filenames...` |
| PIP INIT | `adapters/pip_init.py` | Installs pinned Python packages for linting. | `packages...` (required); `--verbose`; `--dry-run 1` |
| PYFMT | `adapters/pyfmt_linter.py` | Formats Python with `isort`, `usort`, and `ruff format`. | `--verbose`; `filenames...` |
| PYPROJECT | `adapters/pyproject_linter.py` | Checks `pyproject.toml` metadata consistency. | `--verbose`; `filenames...` |
| PYREFLY | `adapters/pyrefly_linter.py` | Runs the `pyrefly` analyser. | `--code CODE`; `--verbose`; `--config PATH` (required) |
| RUFF | `adapters/ruff_linter.py` | Wraps `ruff check` with optional autofix follow-up. | `--config PATH`; `--explain`; `--show-disable`; `--timeout SEC`; `--severity CODE:LEVEL` (repeatable); `--no-fix`; plus default `--retries`, `--verbose`, and `filenames...` from `add_default_options`. |
| S3 INIT | `adapters/s3_init.py` | Downloads prebuilt binaries referenced by adapters. | `--config-json PATH` (required); `--linter NAME` (required); `--output-dir DIR`; `--output-name NAME`; `--dry-run {0,1}` |
| SET_LINTER | `adapters/set_linter.py` | Rewrites raw `set` usage to `OrderedSet`. | Shared `FileLinter` flags (`--fix`, `--lintrunner`, `--verbose`, `files...`). |
| SHELLCHECK | `adapters/shellcheck_linter.py` | Calls `shellcheck` with JSON output. | `filenames...` |
| TESTOWNERS | `adapters/testowners_linter.py` | Ensures test files declare valid owners. | `filenames...` |
| TEST_DEVICE_BIAS | `adapters/test_device_bias_linter.py` | Flags CUDA-specific assumptions in tests. | `filenames...` |
| TEST_HAS_MAIN | `adapters/test_has_main_linter.py` | Requires a `__main__` guard that runs the test suite. | `filenames...` |
| UPDATE_S3 | `adapters/update_s3.py` | Uploads refreshed binaries and updates hashes. | `--config-json PATH` (required); `--linter NAME` (required); `--platform NAME`; `--file PATH` (required); `--dry-run` |
| WORKFLOWSYNC | `adapters/workflow_consistency_linter.py` | Checks that jobs with the same `sync-tag` match. | `filenames...` |

The helper `clang_tidy/generate_build_files.py` uses no CLI options: it updates
submodules, rebuilds `setup.py`, and reruns code generation before
`clangtidy_linter.py` executes.

## Requirements
- **Python runtime**: adapters target the repository's supported Python version
  (tooling is validated with Python 3.12). Activate the same interpreter locally.
- **Python packages**: `ruamel.yaml`, `typing_extensions`, `libcst`, `isort`,
  `usort`, `ruff`, `codespell_lib`, `packaging`, `boto3`, and other packages
  pinned by `pip_init.py`.
- **Native tooling**: `clang-format`, `clang-tidy`, `cmakelint`, `shellcheck`,
  `actionlint`, `bazel`, `grep`, `sed`, and any binaries referenced in
  `s3_init_config.json`. `lintrunner init` installs the correct versions.
- **Repository build prerequisites**: the clang-tidy adapter expects generated
  code (`torchgen`) and `compile_commands.json`; the helper script in
  `clang_tidy/` produces both.

## Installation

### Prerequisites
- **Python 3.12+** (or the version specified in the project)
- **pip** or **conda** for package management
- **Git** for version control
- **CMake 3.18+** (for C++ linting)
- **Clang tools** (for C++ formatting and analysis)

### Platform-Specific Setup

#### Linux/macOS
```bash
# Install system dependencies (Ubuntu/Debian)
sudo apt-get update
sudo apt-get install -y python3-pip python3-dev cmake clang-format clang-tidy

# Or with Homebrew (macOS)
brew install python cmake clang-format llvm
```

#### Windows
```bash
# Using Chocolatey
choco install python cmake llvm

# Or using vcpkg
vcpkg install cmake:x64-windows clang-tools:x64-windows
```

### Step-by-Step Installation

1. **Install lintrunner** (if not already installed):
   ```bash
   pip install lintrunner==0.12.7
   ```

2. **Initialize lintrunner** (installs all dependencies):
   ```bash
   lintrunner init
   ```
   This command will:
   - Install all Python packages specified in `pip_init.py`
   - Download prebuilt binaries for `clang-format`, `clang-tidy`, etc.
   - Set up the `.lintbin` directory with linter binaries

3. **Verify installation**:
   ```bash
   lintrunner -V
   ```
   Should output the version number (e.g., `lintrunner 0.12.7`)

4. **Optional: Prepare clang-tidy build artifacts** (only if using CLANGTIDY linter):
   ```bash
   python Tools/linter/clang_tidy/generate_build_files.py
   ```

### Manual Installation (Alternative)

If you prefer to install components individually:

```bash
# Install Python dependencies
python Tools/linter/adapters/pip_init.py \
  flake8==7.3.0 \
  ruff==0.13.1 \
  cmakelint==1.4.1 \
  codespell[toml]==2.4.1

# Fetch prebuilt binaries
python Tools/linter/adapters/s3_init.py \
  --config-json Tools/linter/adapters/s3_init_config.json \
  --linter clang-format \
  --output-dir .lintbin \
  --output-name clang-format
```

## Usage Examples

### Running All Linters
```bash
# Run all linters on changed files
lintrunner

# Run all linters on all files
lintrunner --all-files

# Run linters and apply fixes automatically
lintrunner --apply-patches
```

### Running Specific Linters
```bash
# Format Python files only
lintrunner --take PYFMT -- python/path/to_module.py

# Check C++ formatting
lintrunner --take CLANGFORMAT -- Library/**/*.h Library/**/*.cxx

# Run clang-tidy on C++ files
lintrunner --take CLANGTIDY -- Library/**/*.cpp

# Validate GitHub workflows
lintrunner --take ACTIONLINT -- .github/workflows/*.yml

# Check Python code with flake8
lintrunner --take FLAKE8 -- Library/**/*.py

# Run CMake linter
lintrunner --take CMAKE -- CMakeLists.txt Cmake/**/*.cmake
```

### Applying Fixes
```bash
# Apply formatting fixes for Python
lintrunner --take PYFMT --apply-patches

# Apply formatting fixes for C++
lintrunner --take CLANGFORMAT --apply-patches

# Apply all available fixes
lintrunner --apply-patches
```

### Dry-Run and Inspection
```bash
# See what would be changed without applying
lintrunner --take PYFMT -- path/to/file.py

# Get detailed output
lintrunner --verbose

# Show which linters are configured
lintrunner --help
```

### Individual Adapter Usage
```bash
# Run flake8 directly
python Tools/linter/adapters/flake8_linter.py Library/**/*.py

# Run clang-format directly
python Tools/linter/adapters/clangformat_linter.py \
  --binary=.lintbin/clang-format \
  Library/**/*.h Library/**/*.cxx

# Run cmake linter directly
python Tools/linter/adapters/cmake_linter.py \
  --config=.cmakelintrc \
  CMakeLists.txt

# Run codespell directly
python Tools/linter/adapters/codespell_linter.py \
  Library/**/*.py Library/**/*.h
```

### Integration with Development Workflow
```bash
# Format code before committing
lintrunner --take PYFMT --take CLANGFORMAT --apply-patches

# Check code quality before pushing
lintrunner --take FLAKE8 --take RUFF --take CLANGTIDY

# Run specific checks on modified files
git diff --name-only | xargs lintrunner
```

## Exit Codes
- Adapters based on `_linter.FileLinter.run()` (`docstring_linter`, `set_linter`,
  and similar) exit with `0` when all files pass or suggested edits are applied,
  and `1` when lint errors remain.
- Wrapper adapters typically return `0` on success, `1` when lint findings are
  emitted, and another non-zero code if the underlying command fails (for
  example, a timeout in `clangformat_linter.py` or a missing binary in
  `shellcheck_linter.py`).
- Utility scripts (`pip_init.py`, `s3_init.py`, `update_s3.py`) exit non-zero if
  provisioning fails.

## Troubleshooting

### Common Issues and Solutions

#### 1. "lintrunner: command not found"
**Problem**: lintrunner is not installed or not in PATH.

**Solution**:
```bash
# Install lintrunner
pip install lintrunner==0.12.7

# Verify installation
lintrunner -V
```

#### 2. "Failed to find provided file" or "No such file or directory"
**Problem**: Linter binary not found (e.g., clang-format, clang-tidy).

**Solution**:
```bash
# Reinitialize lintrunner to download binaries
lintrunner init

# Or manually fetch specific binary
python Tools/linter/adapters/s3_init.py \
  --config-json Tools/linter/adapters/s3_init_config.json \
  --linter clang-format \
  --output-dir .lintbin
```

#### 3. "Python module not found" (e.g., "No module named 'flake8'")
**Problem**: Python dependencies not installed.

**Solution**:
```bash
# Reinstall Python dependencies
python Tools/linter/adapters/pip_init.py \
  flake8==7.3.0 \
  ruff==0.13.1 \
  cmakelint==1.4.1

# Or use lintrunner init
lintrunner init
```

#### 4. "Permission denied" on shell scripts
**Problem**: Shell scripts don't have execute permissions.

**Solution**:
```bash
# On Linux/macOS
chmod +x Scripts/*.sh

# On Windows, this is usually not an issue
```

#### 5. Linter reports false positives in ThirdParty
**Problem**: ThirdParty directory is being linted when it shouldn't be.

**Solution**:
Verify that `.lintrunner.toml` and `.flake8` have `ThirdParty/**` in their exclude patterns:

```bash
# Check .lintrunner.toml
grep -A 5 "exclude_patterns" .lintrunner.toml | grep ThirdParty

# Check .flake8
grep ThirdParty .flake8
```

If missing, update the configuration files to include:
- `.lintrunner.toml`: Add `'ThirdParty/**'` to `exclude_patterns` for each linter
- `.flake8`: Add `./ThirdParty` to the `exclude` section

#### 6. "TOML parsing error" or "Invalid configuration"
**Problem**: Configuration file has syntax errors.

**Solution**:
```bash
# Validate TOML syntax
python -c "
import tomllib
with open('.lintrunner.toml', 'rb') as f:
    config = tomllib.load(f)
    print('Configuration is valid')
"

# Check for common issues:
# - Missing commas in lists
# - Unclosed strings or brackets
# - Invalid escape sequences
```

#### 7. Linter hangs or times out
**Problem**: Linter is taking too long to complete.

**Solution**:
```bash
# Run with verbose output to see progress
lintrunner --verbose

# Increase timeout (if supported by adapter)
lintrunner --take CLANGFORMAT -- --timeout 300

# Run on specific files instead of all files
lintrunner -- path/to/specific/file.py
```

#### 8. Cross-platform path issues
**Problem**: Paths work on Linux/macOS but not on Windows (or vice versa).

**Solution**:
- Use forward slashes (`/`) in configuration files (they work on all platforms)
- Use glob patterns (`**/*.py`) instead of shell-specific patterns
- Avoid hardcoded absolute paths; use relative paths instead

Example:
```toml
# ✓ Correct (works on all platforms)
include_patterns = ['Library/**/*.h', 'Library/**/*.cxx']

# ✗ Incorrect (Windows-specific)
include_patterns = ['Library\\**\\*.h']
```

#### 9. "No files to lint" or linter skips all files
**Problem**: Include/exclude patterns are too restrictive.

**Solution**:
```bash
# Check what files would be linted
lintrunner --verbose -- Library/

# Verify patterns in configuration
grep -A 10 "include_patterns\|exclude_patterns" .lintrunner.toml
```

#### 10. Performance issues with large codebases
**Problem**: Linting is very slow.

**Solution**:
```bash
# Run linters in parallel (if supported)
lintrunner --jobs 4

# Lint only changed files
git diff --name-only | xargs lintrunner

# Run specific linters instead of all
lintrunner --take FLAKE8 --take RUFF
```

### Getting Help

- **Check linter documentation**: Each adapter has built-in help
  ```bash
  python Tools/linter/adapters/flake8_linter.py --help
  python Tools/linter/adapters/clangformat_linter.py --help
  ```

- **Review configuration**: Check `.lintrunner.toml`, `.flake8`, and `.cmakelintrc`

- **Enable verbose logging**: Use `--verbose` flag for detailed output

- **Check project documentation**: See `Tools/linter/README.md` for adapter-specific details

## Cross-Platform Compatibility

### Configuration Files
All configuration files use cross-platform conventions:

- **Path separators**: Use forward slashes (`/`) in all configuration files
- **Glob patterns**: Use `**` for recursive matching (works on all platforms)
- **Relative paths**: All paths are relative to the repository root
- **Line endings**: Configuration files use POSIX line endings (LF)

### Platform-Specific Considerations

#### Linux/macOS
- Shell scripts in `Scripts/` directory use bash
- Clang tools are typically installed via package managers
- Python is usually available as `python3`

#### Windows
- Shell scripts should use `.bat` or PowerShell equivalents
- Clang tools can be installed via Chocolatey or vcpkg
- Python is usually available as `python` or `python3`
- Path handling is automatic (forward slashes work in Python)

### Testing Configuration Across Platforms

```bash
# Verify configuration is valid on all platforms
python -c "
import tomllib
with open('.lintrunner.toml', 'rb') as f:
    config = tomllib.load(f)
    print(f'✓ Configuration valid: {len(config[\"linter\"])} linters')
"

# Test a specific linter
lintrunner --take FLAKE8 -- Library/Core/**/*.py

# Verify ThirdParty exclusion works
lintrunner --verbose -- ThirdParty/ 2>&1 | grep -i "skip\|exclude"
```

## Integration

### Local Development
- **Editor integration**: Add `lintrunner --take PYFMT --take CLANGFORMAT --apply-patches` to editor-on-save hooks
- **Pre-commit hooks**: Use `Scripts/setup_git_hooks.py` to install git hooks that run linters before commits
- **IDE integration**: Configure your IDE to run linters on file save

### Pre-Submit Checks
```bash
# Before pushing, run all linters
lintrunner --apply-patches

# Or run specific checks
lintrunner --take FLAKE8 --take RUFF --take CLANGFORMAT
```

### CI/CD Pipelines
```yaml
# Example GitHub Actions workflow
- name: Run linters
  run: |
    lintrunner init
    lintrunner --take PYFMT --take RUFF --take MYPY --take CLANGFORMAT
```

### Binary Refresh Workflow
When updating linter binaries:
```bash
# Update and upload new binaries
python Tools/linter/adapters/update_s3.py \
  --config-json Tools/linter/adapters/s3_init_config.json \
  --linter clang-format \
  --platform Linux-x86_64 \
  --file dist/clang-format

# Commit updated configuration
git add Tools/linter/adapters/s3_init_config.json
git commit -m "Update clang-format binary"
```

## Configuration Reference

### .lintrunner.toml
Main configuration file for all linters. Key sections:
- `include_patterns`: File patterns to lint
- `exclude_patterns`: File patterns to skip (includes `ThirdParty/**`)
- `command`: Linter command to run
- `init_command`: Setup command (installs dependencies)

### .flake8
Python linting configuration. Key settings:
- `select`: Error codes to check
- `ignore`: Error codes to ignore
- `exclude`: Directories to skip (includes `./ThirdParty`)
- `max-line-length`: Maximum line length

### .cmakelintrc
CMake linting configuration. Specifies:
- `filter`: Which checks to enable/disable

### Tools/linter/dictionary.txt
Shared dictionary for `codespell`. Add words that should not be flagged as misspellings.

## Centralizing Lint Configuration

All lint configuration is centralized under `Tools/linter` to ensure:
- **Consistency**: Same rules apply locally and in CI/CD
- **Maintainability**: Single source of truth for all linting rules
- **Extensibility**: New adapters can reuse existing protocol with minimal boilerplate
- **Cross-platform**: Configuration works on Linux, macOS, and Windows




