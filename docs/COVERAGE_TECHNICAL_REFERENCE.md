# Code Coverage Technical Reference

**Last Updated**: October 19, 2025

## Architecture Overview

```
Build Pipeline with Coverage:
  1. Config (CMake with -fprofile-instr-generate -fcoverage-mapping)
  2. Build (Compilation with coverage instrumentation)
  3. CppCheck (Static analysis)
  4. Test (CTest execution - generates .profraw files)
  5. Coverage (Report generation)
     â”œâ”€â”€ Try: oss_coverage.py (PyTorch tool)
     â””â”€â”€ Fallback: Manual LLVM tools
  6. Analyze (Coverage analysis)
```

## LLVM Coverage Report Generation

### Text Report Command
```bash
llvm-cov report <test_exe> \
  -instr-profile=<profdata_file> \
  -ignore-filename-regex=.*[Tt]est.*
```

**Output**: Human-readable coverage statistics
- Line coverage percentages
- Function coverage percentages
- Region coverage percentages
- Branch coverage percentages

### HTML Report Command
```bash
llvm-cov show <test_exe> \
  -instr-profile=<profdata_file> \
  -format=html \
  -output-dir=<html_dir> \
  -ignore-filename-regex=.*[Tt]est.*
```

**Output**: Interactive HTML report with:
- File-by-file coverage breakdown
- Line-by-line coverage visualization
- Color-coded coverage status
- Clickable navigation

## Test File Exclusion

### Regex Pattern
```
-ignore-filename-regex=.*[Tt]est.*
```

### What Gets Excluded
- Files with "Test" in path (case-insensitive)
- Examples:
  - `Library/Core/Testing/Cxx/TestAllocator.cxx`
  - `Library/Core/Testing/Cxx/TestMemory.cxx`
  - `build/Testing/Temporary/`

### What Gets Included
- All source files in `Library/Core/`
- All header files in `Library/Core/`
- Third-party libraries (fmt, benchmark, etc.)

## Build Directory Structure

### XSigma Build Layout
```
c:\dev\
â”œâ”€â”€ XSigma\                          (source tree)
â”‚   â”œâ”€â”€ Scripts\
â”‚   â”‚   â””â”€â”€ setup.py
â”‚   â”œâ”€â”€ Library\
â”‚   â”œâ”€â”€ ThirdParty\
â”‚   â””â”€â”€ tools\
â”‚       â””â”€â”€ code_coverage\
â””â”€â”€ build_ninja_tbb_coverage\        (build directory - OUTSIDE source)
    â”œâ”€â”€ bin\
    â”‚   â”œâ”€â”€ CoreCxxTests.exe
    â”‚   â”œâ”€â”€ CoreCxxBenchmark.exe
    â”‚   â”œâ”€â”€ default.profraw          (coverage data)
    â”‚   â””â”€â”€ *.dll
    â”œâ”€â”€ coverage.profdata            (merged coverage data)
    â”œâ”€â”€ coverage_report.txt          (text report)
    â””â”€â”€ coverage_html\               (HTML report)
        â”œâ”€â”€ index.html
        â”œâ”€â”€ control.js
        â”œâ”€â”€ style.css
        â””â”€â”€ coverage\
```

## Coverage Data Files

### .profraw Files
- **Generated by**: Clang compiler during test execution
- **Location**: `build_ninja_tbb_coverage/bin/`
- **Size**: ~5.3 MB per test run
- **Format**: LLVM raw profile data
- **Lifetime**: Temporary (merged into .profdata)

### .profdata Files
- **Generated by**: `llvm-profdata merge`
- **Location**: `build_ninja_tbb_coverage/`
- **Size**: ~945 KB (merged)
- **Format**: LLVM indexed profile data
- **Lifetime**: Persistent (used for report generation)

## Environment Variables

### Set by setup.py
```python
env["HOME"] = os.environ.get("USERPROFILE", os.path.expanduser("~"))
env["CXX"] = "clang++"  # or "g++"
env["XSIGMA_FOLDER"] = source_path
```

### Used by oss_coverage.py
- `HOME`: Home directory (Windows compatibility)
- `CXX`: Compiler detection
- `XSIGMA_FOLDER`: Project root path

## Coverage Report Interpretation

### Coverage Percentages
- **100.00%**: All code executed
- **50-99%**: Partially executed
- **0.00%**: Not executed

### Color Coding (HTML)
- ðŸŸ¢ Green: High coverage (>80%)
- ðŸŸ¡ Yellow: Medium coverage (50-80%)
- ðŸ”´ Red: Low coverage (<50%)
- âšª Gray: No branches/regions

### Metrics Explained
- **Line Coverage**: Percentage of executable lines executed
- **Function Coverage**: Percentage of functions called
- **Region Coverage**: Percentage of code regions executed
- **Branch Coverage**: Percentage of conditional branches taken

## Fallback Mechanism

### Primary Path
1. Try `oss_coverage.py` (PyTorch tool)
2. If succeeds: Use generated reports
3. If fails: Continue to fallback

### Fallback Path
1. Try manual LLVM tools
2. Merge .profraw files
3. Generate text report
4. Generate HTML report
5. If fails: Try legacy script

### Legacy Script
- Script: `Scripts/compute_code_coverage_locally.sh`
- Purpose: Final fallback for coverage collection
- Runs: `ctest` with coverage environment

## Troubleshooting

### No .profraw Files Generated
- **Cause**: Tests not running
- **Solution**: Check test execution in build log
- **Verify**: `ls build_ninja_tbb_coverage/bin/*.profraw`

### oss_coverage.py Fails
- **Cause**: Test discovery path mismatch
- **Solution**: Fallback to LLVM tools (automatic)
- **Check**: Build log for "Attempting to generate coverage reports manually"

### HTML Report Not Generated
- **Cause**: `llvm-cov show` command failed
- **Solution**: Check LLVM installation
- **Verify**: `llvm-cov --version`

### Test Files in Report
- **Cause**: Regex pattern not applied
- **Solution**: Verify `-ignore-filename-regex` flag
- **Check**: Coverage report for "Testing" directory entries

## Performance Metrics

### Build Time Impact
- **Without Coverage**: ~8-9 seconds
- **With Coverage**: ~9-10 seconds
- **Overhead**: ~10-15%

### Coverage Generation Time
- **Merge .profraw**: ~0.5 seconds
- **Generate Text Report**: ~0.5 seconds
- **Generate HTML Report**: ~1.5 seconds
- **Total**: ~2.5 seconds

### Report Sizes
- **Text Report**: 14 KB
- **HTML Report**: 24 KB (+ coverage/ subdirectory)
- **Merged Data**: 945 KB

## Best Practices

1. **Run Coverage Regularly**: Include in CI/CD pipeline
2. **Review Reports**: Check HTML report for coverage gaps
3. **Add Tests**: Improve coverage for uncovered code
4. **Track Trends**: Monitor coverage over time
5. **Exclude Appropriately**: Use regex to exclude test files

## References

- [LLVM Source-Based Code Coverage](http://clang.llvm.org/docs/SourceBasedCodeCoverage.html)
- [Clang Instrumentation Flags](https://clang.llvm.org/docs/Instrumentation.html)
- [llvm-cov Documentation](https://llvm.org/docs/CommandGuide/llvm-cov.html)
- [llvm-profdata Documentation](https://llvm.org/docs/CommandGuide/llvm-profdata.html)

